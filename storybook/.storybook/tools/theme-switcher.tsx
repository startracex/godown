import { memo, useEffect, useState } from "react";
import { IconButton } from "storybook/internal/components";
import { addons } from "storybook/internal/manager-api";
import { themes } from "../themes/index.js";
import React from "react";

const IconAuto = memo(() => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 14 14"
    height="14"
    width="14"
  >
    <path
      fill="currentColor"
      d="M7 12.833333333333334c-0.8069541666666668 0 -1.5652875 -0.153125 -2.275 -0.45937500000000003 -0.7097125000000001 -0.30625 -1.3270833333333334 -0.721875 -1.8520833333333333 -1.2468750000000002 -0.525 -0.525 -0.940625 -1.1423708333333333 -1.2468750000000002 -1.8520833333333333C1.319791666666667 8.5652875 1.1666666666666667 7.806954166666667 1.1666666666666667 7s0.153125 -1.5652875 0.45937500000000003 -2.275c0.30625 -0.7097125000000001 0.721875 -1.3270833333333334 1.2468750000000002 -1.8520833333333333 0.525 -0.525 1.1423708333333333 -0.940625 1.8520833333333333 -1.2468750000000002C5.4347125 1.319791666666667 6.193045833333334 1.1666666666666667 7 1.1666666666666667s1.5652875 0.153125 2.275 0.45937500000000003c0.7097125000000001 0.30625 1.3270833333333334 0.721875 1.8520833333333333 1.2468750000000002 0.525 0.525 0.940625 1.1423708333333333 1.2468750000000002 1.8520833333333333C12.680208333333335 5.4347125 12.833333333333334 6.193045833333334 12.833333333333334 7s-0.153125 1.5652875 -0.45937500000000003 2.275c-0.30625 0.7097125000000001 -0.721875 1.3270833333333334 -1.2468750000000002 1.8520833333333333 -0.525 0.525 -1.1423708333333333 0.940625 -1.8520833333333333 1.2468750000000002C8.5652875 12.680208333333335 7.806954166666667 12.833333333333334 7 12.833333333333334Zm0.2916666666666667 -0.875c1.3319541666666668 -0.09721250000000001 2.4427083333333335 -0.6125 3.332291666666667 -1.5458333333333334C11.513541666666669 9.479166666666668 11.958333333333334 8.341666666666667 11.958333333333334 7s-0.4447916666666667 -2.479166666666667 -1.334375 -3.4125C9.734375 2.654166666666667 8.623620833333334 2.138887916666667 7.291666666666667 2.041666666666667v9.916666666666668Z"
      stroke-width="0.2917"
    />
  </svg>
));

const IconDark = memo(() => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 14 14"
    height="14"
    width="14"
  >
    <path
      fill="currentColor"
      d="M7 12.25c-1.4583333333333335 0 -2.697916666666667 -0.5104166666666667 -3.7187500000000004 -1.53125S1.75 8.458333333333334 1.75 7s0.5104166666666667 -2.697916666666667 1.53125 -3.7187500000000004S5.541666666666667 1.75 7 1.75c0.07778750000000001 0 0.16041666666666668 0.0024295833333333335 0.24791666666666667 0.007291666666666668 0.08750000000000001 0.004862083333333334 0.19929583333333334 0.01215375 0.33541666666666664 0.021875000000000002 -0.35000000000000003 0.31111208333333334 -0.6222125000000001 0.6951379166666667 -0.8166666666666667 1.1520833333333333 -0.19445416666666668 0.4569541666666667 -0.2916666666666667 0.9382041666666667 -0.2916666666666667 1.44375 0 0.875 0.30625 1.6187500000000001 0.9187500000000001 2.23125 0.6125 0.6125 1.3562500000000002 0.9187500000000001 2.23125 0.9187500000000001 0.5055458333333334 0 0.9867958333333334 -0.08992083333333334 1.44375 -0.2697916666666667S11.909712500000001 6.825 12.220833333333333 6.504166666666667c0.009712500000000002 0.11666666666666668 0.017004166666666667 0.21145833333333333 0.021875000000000002 0.284375S12.25 6.931954166666667 12.25 7c0 1.4583333333333335 -0.5104166666666667 2.697916666666667 -1.53125 3.7187500000000004S8.458333333333334 12.25 7 12.25Z"
      stroke-width="0.2917"
    />
  </svg>
));

const IconLight = memo(() => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 14 14"
    height="14"
    width="14"
  >
    <path
      fill="currentColor"
      d="M7 9.916666666666668c-0.8069541666666668 0 -1.4947916666666667 -0.284375 -2.063541666666667 -0.853125C4.367708333333334 8.494791666666668 4.083333333333334 7.806954166666667 4.083333333333334 7s0.284375 -1.4947916666666667 0.853125 -2.063541666666667C5.505208333333334 4.367708333333334 6.193045833333334 4.083333333333334 7 4.083333333333334s1.4947916666666667 0.284375 2.063541666666667 0.853125C9.632291666666667 5.505208333333334 9.916666666666668 6.193045833333334 9.916666666666668 7s-0.284375 1.4947916666666667 -0.853125 2.063541666666667C8.494791666666668 9.632291666666667 7.806954166666667 9.916666666666668 7 9.916666666666668ZM1.0208333333333335 7.437500000000001c-0.12395833333333334 0 -0.22784125000000002 -0.04220416666666667 -0.31164583333333334 -0.12658333333333335C0.62528375 7.226625000000001 0.5833333333333334 7.122120833333335 0.5833333333333334 6.997375c0 -0.12462916666666668 0.04195041666666667 -0.2282875 0.12585416666666668 -0.31091666666666673 0.08380458333333334 -0.08262916666666667 0.1876875 -0.12395833333333334 0.31164583333333334 -0.12395833333333334h1.4583333333333335c0.12395833333333334 0 0.22788791666666666 0.04220416666666667 0.3117916666666667 0.12658333333333335 0.08380458333333334 0.08429166666666667 0.12570833333333334 0.18879583333333333 0.12570833333333334 0.31354166666666666 0 0.12462916666666668 -0.041903750000000003 0.2282875 -0.12570833333333334 0.31091666666666673 -0.08390375 0.08262916666666667 -0.18783333333333335 0.12395833333333334 -0.3117916666666667 0.12395833333333334h-1.4583333333333335Zm10.5 0c-0.12395833333333334 0 -0.22785000000000002 -0.04220416666666667 -0.31164583333333334 -0.12658333333333335 -0.08391250000000001 -0.08429166666666667 -0.12585416666666668 -0.18879583333333333 -0.12585416666666668 -0.31354166666666666 0 -0.12462916666666668 0.041941666666666676 -0.2282875 0.12585416666666668 -0.31091666666666673 0.08379583333333333 -0.08262916666666667 0.1876875 -0.12395833333333334 0.31164583333333334 -0.12395833333333334h1.4583333333333335c0.12395833333333334 0 0.2278791666666667 0.04220416666666667 0.3117916666666667 0.12658333333333335 0.08379583333333333 0.08429166666666667 0.12570833333333334 0.18879583333333333 0.12570833333333334 0.31354166666666666 0 0.12462916666666668 -0.0419125 0.2282875 -0.12570833333333334 0.31091666666666673 -0.08391250000000001 0.08262916666666667 -0.18783333333333335 0.12395833333333334 -0.3117916666666667 0.12395833333333334h-1.4583333333333335ZM6.997375 2.916666666666667c-0.12462916666666668 0 -0.2282875 -0.04195041666666667 -0.31091666666666673 -0.12585416666666668 -0.08262916666666667 -0.08380458333333334 -0.12395833333333334 -0.1876875 -0.12395833333333334 -0.31164583333333334v-1.4583333333333335c0 -0.12395833333333334 0.04220416666666667 -0.22788791666666666 0.12658333333333335 -0.3117916666666667 0.08429166666666667 -0.08380458333333334 0.18879583333333333 -0.12570833333333334 0.31354166666666666 -0.12570833333333334 0.12462916666666668 0 0.2282875 0.041903750000000003 0.31091666666666673 0.12570833333333334 0.08262916666666667 0.08390375 0.12395833333333334 0.18783333333333335 0.12395833333333334 0.3117916666666667v1.4583333333333335c0 0.12395833333333334 -0.04220416666666667 0.22784125000000002 -0.12658333333333335 0.31164583333333334 -0.08429166666666667 0.08390375 -0.18879583333333333 0.12585416666666668 -0.31354166666666666 0.12585416666666668Zm0 10.5c-0.12462916666666668 0 -0.2282875 -0.041941666666666676 -0.31091666666666673 -0.12585416666666668 -0.08262916666666667 -0.08379583333333333 -0.12395833333333334 -0.1876875 -0.12395833333333334 -0.31164583333333334v-1.4583333333333335c0 -0.12395833333333334 0.04220416666666667 -0.2278791666666667 0.12658333333333335 -0.3117916666666667 0.08429166666666667 -0.08379583333333333 0.18879583333333333 -0.12570833333333334 0.31354166666666666 -0.12570833333333334 0.12462916666666668 0 0.2282875 0.0419125 0.31091666666666673 0.12570833333333334 0.08262916666666667 0.08391250000000001 0.12395833333333334 0.18783333333333335 0.12395833333333334 0.3117916666666667v1.4583333333333335c0 0.12395833333333334 -0.04220416666666667 0.22785000000000002 -0.12658333333333335 0.31164583333333334 -0.08429166666666667 0.08391250000000001 -0.18879583333333333 0.12585416666666668 -0.31354166666666666 0.12585416666666668ZM3.5 4.1125l-0.83125 -0.8166666666666667c-0.08750000000000001 -0.08750000000000001 -0.12945041666666668 -0.19250000000000003 -0.12585416666666668 -0.31500000000000006 0.0035962500000000005 -0.12259625 0.045062500000000005 -0.22711208333333335 0.12439583333333334 -0.31354166666666666 0.08642958333333334 -0.08652875 0.19094541666666667 -0.12979166666666667 0.31354166666666666 -0.12979166666666667 0.1225 0 0.22750000000000004 0.043750000000000004 0.31500000000000006 0.13125L4.1125 3.5c0.07778750000000001 0.08750000000000001 0.11666666666666668 0.18958333333333335 0.11666666666666668 0.30625s-0.03887916666666667 0.21632916666666668 -0.11666666666666668 0.2989583333333333c-0.07778750000000001 0.08262916666666667 -0.17742083333333333 0.12395833333333334 -0.2989583333333333 0.12395833333333334 -0.1215375 0 -0.2260416666666667 -0.03887916666666667 -0.31354166666666666 -0.11666666666666668Zm7.204166666666667 7.218750000000001L9.887500000000001 10.5c-0.07778750000000001 -0.08750000000000001 -0.11666666666666668 -0.19142083333333335 -0.11666666666666668 -0.3117916666666667 0 -0.12025416666666668 0.04132916666666667 -0.22050000000000003 0.12395833333333334 -0.30070833333333336 0.08262916666666667 -0.08750000000000001 0.18229166666666669 -0.13125 0.2989583333333333 -0.13125 0.11666666666666668 0 0.21875 0.043750000000000004 0.30625 0.13125l0.83125 0.8166666666666667c0.08750000000000001 0.08750000000000001 0.12944166666666668 0.19250000000000003 0.12585416666666668 0.31500000000000006 -0.0035875000000000004 0.12258750000000002 -0.045062500000000005 0.22712083333333333 -0.12439583333333334 0.31354166666666666 -0.08642083333333334 0.08653750000000002 -0.19095416666666667 0.12979166666666667 -0.31354166666666666 0.12979166666666667 -0.1225 0 -0.22750000000000004 -0.043750000000000004 -0.31500000000000006 -0.13125ZM9.887500000000001 4.1125c-0.08750000000000001 -0.08750000000000001 -0.13125 -0.18958333333333335 -0.13125 -0.30625s0.043750000000000004 -0.21875 0.13125 -0.30625l0.8166666666666667 -0.83125c0.08750000000000001 -0.08750000000000001 0.19250000000000003 -0.12945041666666668 0.31500000000000006 -0.12585416666666668 0.12258750000000002 0.0035962500000000005 0.22712083333333333 0.045062500000000005 0.31354166666666666 0.12439583333333334 0.08653750000000002 0.08642958333333334 0.12979166666666667 0.19094541666666667 0.12979166666666667 0.31354166666666666 0 0.1225 -0.043750000000000004 0.22750000000000004 -0.13125 0.31500000000000006L10.5 4.1125c-0.07778750000000001 0.07778750000000001 -0.17675000000000002 0.11666666666666668 -0.2969166666666667 0.11666666666666668 -0.12025416666666668 0 -0.22545833333333334 -0.03887916666666667 -0.3155833333333334 -0.11666666666666668ZM2.667291666666667 11.332708333333333c-0.08652875 -0.08642083333333334 -0.12979166666666667 -0.19095416666666667 -0.12979166666666667 -0.31354166666666666 0 -0.1225 0.043750000000000004 -0.22750000000000004 0.13125 -0.31500000000000006L3.5 9.887500000000001c0.08554583333333333 -0.08750000000000001 0.18716250000000004 -0.13125 0.3047916666666667 -0.13125 0.11762916666666667 0 0.21831250000000002 0.043750000000000004 0.3020208333333334 0.13125 0.09129166666666667 0.08750000000000001 0.1369375 0.18958333333333335 0.1369375 0.30625s-0.043750000000000004 0.21875 -0.13125 0.30625l-0.8166666666666667 0.83125c-0.08750000000000001 0.08750000000000001 -0.19250000000000003 0.12944166666666668 -0.31500000000000006 0.12585416666666668 -0.12259625 -0.0035875000000000004 -0.22711208333333335 -0.045062500000000005 -0.31354166666666666 -0.12439583333333334Z"
      stroke-width="0.2917"
    />
  </svg>
));

const themeDisplay = {
  auto: ["Auto", <IconAuto />],
  dark: ["Dark", <IconDark />],
  light: ["Light", <IconLight />],
};

const themeKeys = Object.keys(themeDisplay);

const matchLight = matchMedia("(prefers-color-scheme: light)");

const specialTheme = (t: string) => (t === "auto" ? (matchLight.matches ? "light" : "dark") : t);

export const ThemeSwitcher = memo(() => {
  const [currentTheme, setCurrentTheme] = useState<string>(localStorage.getItem("theme") || "auto");

  const nextTheme = themeKeys[(themeKeys.indexOf(currentTheme) + 1) % themeKeys.length];
  const [label, icon] = themeDisplay[currentTheme];

  const applyTheme = (t: string) => {
    const key = specialTheme(t);
    addons.setConfig({
      theme: themes[specialTheme(key)],
      themeKey: specialTheme(key),
    });
    document.documentElement.dataset.theme = key;
    document.dispatchEvent(new CustomEvent("theme-change", { detail: key }));
  };

  useEffect(() => {
    applyTheme(currentTheme);
  }, []);

  return (
    <IconButton
      title="Change theme"
      onClick={() => {
        applyTheme(nextTheme);
        localStorage.setItem("theme", nextTheme);
        setCurrentTheme(nextTheme);
      }}
    >
      {icon}
      {label}
    </IconButton>
  );
});
